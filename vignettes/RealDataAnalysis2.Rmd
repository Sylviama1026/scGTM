---
title: "Real Data Analysis Example 2"
author: 
  - name: Dongyuan Song
    affiliation:
    - Bioinformatics IDP, University of California, Los Angeles
    email: dongyuansong@ucla.edu
  - name: Lehan Zou
    affiliation:
    - Dertment of Statistics, University of California, Los Angeles
    email: lehanz77@g.ucla.edu
  - name: Shiyu Ma
    affiliation:
    - Department of Statistics, University of California, Los Angeles
    email: sylviama1026@g.ucla.edu
output:   
  rmarkdown::html_vignette

vignette: >
  %\VignetteIndexEntry{Real Data Analysis Example 2}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Real Data Analysis Example 2
scGTM identifies informative gene expression trends after immune cell stimulation.

As in the second real data example, we use the scGTM to categorize gene expression trends in mouse dendritic cells(DCs) after simulation with lipopolysaccharide (LPS). 

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(SingleCellExperiment))
suppressPackageStartupMessages(library(ComplexHeatmap))
suppressPackageStartupMessages(library(clusterExperiment))
suppressPackageStartupMessages(library(viridis))
suppressPackageStartupMessages(library(useful))
suppressPackageStartupMessages(library(RColorBrewer))
suppressPackageStartupMessages(library(umap))
suppressPackageStartupMessages(library(plotly))
suppressPackageStartupMessages(library(clusterProfiler))
suppressPackageStartupMessages(library(nichenetr))
suppressPackageStartupMessages(library(ggpubr))
suppressPackageStartupMessages(library(org.Hs.eg.db))
suppressPackageStartupMessages(library(org.Mm.eg.db))
theme_set(theme_bw())
```

```{r}
LPS_sce <- read_csv("LPS data.csv")

Poisson_para <- read_csv("Poisson_para.csv")
```

```{r}
gene_counts <- LPS_sce %>% dplyr::rename(cell_id = `Unnamed: 0`)
```


```{r}
gene_counts <- gene_counts  %>% tidyr::pivot_longer(!c("pseudotime", "cell_id"), names_to = "gene") %>% dplyr::mutate(`log(count+1)` = log1p(value))
```

## Poisson

```{r}
Poisson_para %>% dplyr::group_by(Transform) %>% dplyr::summarise(n())
```

### Cal intercept model

```{r}
LPS_counts <- LPS_sce %>% dplyr::select(-c("Unnamed: 0", "pseudotime")) %>% t()
```

```{r}
pseudotime <- LPS_sce$pseudotime
Poisson_loglik <- apply(LPS_counts, 1, function(gene) {
  fit <- mgcv::gam(gene ~ 1, family = "poisson")
  -logLik(fit)})
```

### Select significant genes

```{r}
Poisson_new <- Poisson_para %>% dplyr::mutate(nzp = rowMeans(LPS_counts!=0))%>% dplyr::mutate(Poisson_para, nllik = Poisson_loglik) %>% dplyr::mutate(llk_diff = 2*(nllik - negative_log_likelihood)) %>% dplyr::arrange(desc(llk_diff)) %>% dplyr::mutate(pvalue = pchisq(llk_diff, 3, lower.tail = FALSE)) %>% dplyr::mutate(adj_pvalue = p.adjust(pvalue, "BH")) %>% dplyr::filter(adj_pvalue < 0.01)
Poisson_new
```

```{r}
gene_counts <- gene_counts %>% dplyr::filter(gene %in% Poisson_new$gene_index)
```

### Convert gene name
```{r}
Poisson_new <- Poisson_new %>% mutate(gene_index = sapply(gene_index, function(x) {
  gene <- str_split(x, "-")[[1]]
  if(length(gene) > 1) {
    gene <- str_to_title(gene)
    gene <- paste(gene[1], gene[2], sep = "-")
  } else {
    gene <- str_to_title(gene)
    
  }
  gene <- gsub("rik", "Rik", gene)
  gene
})) 

gene_counts <- gene_counts %>% mutate(gene = sapply(gene, function(x) {
  gene <- str_split(x, "-")[[1]]
  if(length(gene) > 1) {
    gene <- str_to_title(gene)
    gene <- paste(gene[1], gene[2], sep = "-")
  } else {
    gene <- str_to_title(gene)
    
  }
  gene
}))
```


```{r}
Poisson_mat <-Poisson_new %>% dplyr::select(-c("...1", "gene_index", "negative_log_likelihood", "phi", "pvalue", "Fisher", "k1_std","k2_std","mu_std")) %>% as.matrix()

```

### Plot curve
```{r}
gene_curve <- function(t, mu, k1, k2, t0) {
  if(t <= t0) v <- mu*exp(-k1*(t-t0)^2)
  else v <- mu*exp(-k2*(t-t0)^2)
  v
}
```

```{r}
gene_predict <- function(gene, pseudotime) {
  i = Poisson_new %>% dplyr::filter(gene_index == gene) %>% as.vector()
  res <- gene_curve(t = pseudotime, mu = as.numeric(i[4]), k1 = abs(as.numeric(i[5])), k2 = abs(as.numeric(i[6])), t0 = as.numeric(i[7]))
  res
}
```

```{r}
gene_predict2 <- function(gene_use, pseudotime) {
  i = Poisson_new %>% dplyr::filter(gene_index == gene_use) %>% as.vector()
  gene_max <- gene_counts %>% group_by(gene) %>% dplyr::summarise(max_value = max(`log(count+1)`)) %>% dplyr::filter(gene == gene_use) %>% .$max_value
  res <- gene_curve(t = pseudotime, mu = as.numeric(i[4]), k1 = abs(as.numeric(i[5])), k2 = abs(as.numeric(i[6])), t0 = as.numeric(i[7]))
  gene_max - res
}
```


### Add scKGAM prediction
```{r}
gene_counts <- gene_counts %>% dplyr::filter(gene %in% Poisson_new$gene_index)
```


we use the scGTM’s confidence levels of the three parameters $t_0$ , $k_1$ , and $k_2$ to categorize the 2405 genes into three types:
1) hill-shaped and mostly increasing genes
2) hill-shaped and mostly decreasing genes
3) valley-shaped genes
### Plot some genes
```{r, fig.height=8}
gene_vec1 <- Poisson_new %>% dplyr::arrange(desc(llk_diff)) %>% dplyr::filter(Transform == 0) %>% dplyr::filter(t0_lower > 0.6 & k1_lower > 1)%>% dplyr::arrange(desc(nzp))

gene_vec <- gene_vec1$gene_index[1:5]
p1 <- gene_counts %>% dplyr::filter(gene %in% gene_vec) %>% dplyr::mutate(prediction = mapply(gene = gene, pseudotime  = pseudotime, FUN = gene_predict)) %>% dplyr::mutate(gene = factor(gene, levels = gene_vec)) %>% ggplot(aes(x = pseudotime, y = `log(count+1)`)) +geom_point(size = 1, alpha = 0.3) + geom_line(aes(y = prediction), color = "blue") + facet_wrap(~gene, scales = "free_y", nrow = 1) +theme(aspect.ratio = 1) + ggtitle("Hill-shaped Genes (Mostly Increasing)")
p1
```

```{r, fig.height=8}
gene_vec2 <- Poisson_new %>% dplyr::arrange(desc(llk_diff)) %>% dplyr::filter(Transform == 0) %>% dplyr::filter(t0_upper < 0.4 & k2_lower > 1) %>% dplyr::arrange(desc(nzp))

gene_vec <- gene_vec2$gene_index[1:5]
p2 <- gene_counts %>% dplyr::filter(gene %in% gene_vec) %>% dplyr::mutate(prediction = mapply(gene = gene, pseudotime  = pseudotime, FUN = gene_predict)) %>% dplyr::mutate(gene = factor(gene, levels = gene_vec)) %>% ggplot(aes(x = pseudotime, y = `log(count+1)`)) +geom_point(size = 1, alpha = 0.3) + geom_line(aes(y = prediction), color = "blue")  + facet_wrap(~gene, scales = "free_y", nrow = 1) +theme(aspect.ratio = 1) +ggtitle("Hill-shaped Genes (Mostly Decreasing)")
p2
```

```{r, fig.height=8}
gene_vec3 <- Poisson_new %>% dplyr::arrange(desc(llk_diff)) %>% dplyr::filter(Transform == 1) %>% dplyr::filter(k1_lower > 1 & k2_lower > 1)%>% dplyr::arrange(desc(nzp))

gene_vec<- gene_vec3$gene_index[1:5]
p3 <- gene_counts %>% dplyr::filter(gene %in% gene_vec) %>% dplyr::mutate(prediction = mapply(gene_use = gene, pseudotime  = pseudotime, FUN = gene_predict2)) %>% dplyr::mutate(gene = factor(gene, levels = gene_vec)) %>% ggplot(aes(x = pseudotime, y = `log(count+1)`)) +geom_point(size = 1, alpha = 0.3) + geom_line(aes(y = prediction), color = "blue")  + facet_wrap(~gene, scales = "free_y", nrow = 1) +theme(aspect.ratio = 1) +ggtitle("Valley-shaped Genes")
p3
```

```{r, fig.width=12}

gcSample <- list(`Mostly Increasing` = gene_vec1$gene_index, `Mostly Decreasing` = gene_vec2$gene_index, `Valley-shaped` = gene_vec3$gene_index)

ck <- compareCluster(geneCluster = gcSample, fun = enrichGO,
                      OrgDb         = org.Mm.eg.db,
                      ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05,
                keyType       = "SYMBOL",
                maxGSSize = 500)

ck2 <- clusterProfiler::simplify(ck, cutoff = 0.6)
p_go <- clusterProfiler::dotplot(ck2, showCategory = 10, font.size = 12, label_format = 30)
```

```{r, fig.width=10,fig.height = 10}
p_go
```


```{r, fig.width=12, fig.height= 12}
p_gene_trend <- ggpubr::ggarrange(p1, p2, p3, ncol = 1, align = "hv")
p_gene_trend
```

```{r, fig.width=12, fig.height=20}
p_LPS <- ggpubr::ggarrange(p_go, p_gene_trend, ncol = 1, heights = c(8, 5), align = "h", labels = c("a", "b"), font.label = list(size = 20, face = "bold", color ="black"))
p_LPS
```


In the LPS dataset, the top enriched GO terms are different among the three gene types: Mostly increasing, Mostly decreasing, and Valley-shaped.This meets our expectation and are biologically interpretable. Notably, the hill-shaped & mostly increasing genes are related to immune response processes, showing consistency between their expression trends (activation after the LPS stimulation) and functions (immune response). Further, the visualization of example genes in the three types is shown in (b). We observe that the scGTM’s fitted trends agree well with the data. In conclusion, the scGTM can help users discern genes with specific trends by its trend-informative parameters.
